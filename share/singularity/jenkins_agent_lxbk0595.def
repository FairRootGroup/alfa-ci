Bootstrap: docker
From: centos:7.6.1810

# build via:
#   singularity build -f -F jenkins_agent.sif jenkins_agent_lxbk0595.def
# run (e.g. via cron):
#   @hourly singularity instance start -B/etc/slurm,/var/run/munge jenkins_agent.sif jenkins_agent || /bin/true

%post
    yum -y install java-11-openjdk wget
    wget -O /opt/agent.jar https://alfa-ci.gsi.de/jnlpJars/agent.jar
    yum -y install https://github.com/openhpc/ohpc/releases/download/v1.3.GA/ohpc-release-1.3-1.el7.x86_64.rpm
    yum -y install ohpc-base ohpc-slurm-client
    yum -y install https://repo.ius.io/ius-release-el7.rpm
    yum -y install git2u

%startscript
    SECRET=REPLACEMEWITHREALSECRET
    JAVA_ARGS="-Dorg.jenkinsci.plugins.gitclient.Git.timeOut=60"
    JAVA_ARGS="$JAVA_ARGS -Dorg.jenkinsci.plugins.gitclient.CliGitAPIImpl.TIMEOUT=60"

    if [ -r "$HOME/.config/jenkins_agent/$(hostname)/config.sh" ]
    then
        source "$HOME/.config/jenkins_agent/$(hostname)/config.sh"
    fi

    java $JAVA_ARGS -jar /opt/agent.jar -jnlpUrl https://alfa-ci.gsi.de/computer/virgo/slave-agent.jnlp -secret "$SECRET" -workDir "/lustre/rz/alfaci" > /tmp/alfaci/agent.log 2>&1

%environment
    export https_proxy=http://proxy-ib2.gsi.de:3128/
    export HTTPS_PROXY=http://proxy-ib2.gsi.de:3128/
    export http_proxy=http://proxy-ib2.gsi.de:3128/
    export HTTP_PROXY=http://proxy-ib2.gsi.de:3128/
    export no_proxy=alfa-ci.gsi.de
    export NO_PROXY=alfa-ci.gsi.de
